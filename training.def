Bootstrap: docker
From: nvidia/cuda:12.8.0-devel-ubuntu24.04

%labels
    Author        Daniel Zhu
    Description   Fully OFFLINE MV-MAE + DrQv2 + MJX Training Environment (CUDA 12.8)

%files
    . /opt/src/MV_MAE_Implementation

%post
    set -e

    echo "[post] === Installing base OS packages ==="
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git build-essential pkg-config curl ca-certificates \
        ffmpeg libavcodec60 libavdevice60 libavformat60 libavfilter9 \
        libswscale7 libswresample4 \
        xvfb x11-utils libx11-dev libxrandr-dev libxinerama-dev \
        libxcursor-dev libxi-dev mesa-common-dev \
        gpg lsb-release libegl1 libegl-dev \
        python3 python3-venv python3-pip
    rm -rf /var/lib/apt/lists/*

    echo "[post] === Creating Python venv ==="
    python3 -m venv /opt/mvmae_venv
    . /opt/mvmae_venv/bin/activate

    python -m pip install -U pip wheel setuptools

    echo "[post] === Setting pip offline environment ==="
    mkdir -p /opt/pip-tmp /opt/pip-cache
    export TMPDIR=/opt/pip-tmp
    export PIP_CACHE_DIR=/opt/pip-cache
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export PIP_NO_INDEX=1

    REQ=/opt/src/MV_MAE_Implementation/requirements.txt
    WHL=/opt/src/MV_MAE_Implementation/wheelhouse

    echo "[post] === Verifying wheelhouse ==="
    if [ ! -d "$WHL" ]; then
        echo "[ERROR] Wheelhouse directory missing at $WHL"
        echo "        OFFLINE build cannot continue."
        exit 3
    fi

    if [ ! -f "$REQ" ]; then
        echo "[ERROR] requirements.txt missing at $REQ"
        exit 2
    fi

    echo "[post] === Installing Python dependencies (offline only) ==="
    python -m pip install --find-links "$WHL" --no-index -r "$REQ"

    echo "[post] === (Optional) Install madrona_mjx from wheelhouse ==="
    # If madrona_mjx has its own wheels inside wheelhouse, install them
    python -m pip install --find-links "$WHL" --no-index madrona-mjx || true

    echo "[post] === Autoload venv at runtime ==="
    mkdir -p /.singularity.d/env
    cat > /.singularity.d/env/99-autovenv.sh <<'EOS'
export VIRTUAL_ENV=/opt/mvmae_venv
export PATH="$VIRTUAL_ENV/bin:$PATH"
export PYTHONPATH="/opt/src:${PYTHONPATH}"
EOS
    chmod 644 /.singularity.d/env/99-autovenv.sh

    echo "[post] === Offline build complete ==="

%environment
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export DISPLAY=:1
    export HF_TOKEN=${HF_TOKEN:-}
    export WANDB_API_KEY=${WANDB_API_KEY:-}

%runscript
    if command -v xdpyinfo >/dev/null 2>&1; then
        if ! xdpyinfo -display "$DISPLAY" >/dev/null 2>&1; then
            Xvfb :1 -screen 0 1280x720x24 -nolisten tcp & sleep 2
        fi
    fi

    echo "[MVMAE] Python: $(python --version)"
    echo "[MVMAE] PYTHONPATH=$PYTHONPATH"
    echo "[MVMAE] Running train_drqv2_mujoco.py ..."

    if [ -f /opt/src/MV_MAE_Implementation/train_drqv2_mujoco.py ]; then
        cd /opt/src
        exec python -m MV_MAE_Implementation.train_drqv2_mujoco "$@"
    else
        echo "[ERROR] train_drqv2_mujoco.py not found. Running passed command."
        exec "$@"
    fi

%help
    This is a fully OFFLINE build.
    You must prepare wheelhouse/ with all required wheels.

    Build:
      apptainer build training.sif training.def

    Run default training script:
      apptainer run --nv training.sif

    Run custom commands:
      apptainer exec --nv training.sif python3 -V
