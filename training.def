Bootstrap: docker
From: nvidia/cuda:12.1.1-runtime-ubuntu22.04

%environment
    # Use EGL (headless GPU rendering)
    export MUJOCO_GL=egl
    export MUJOCO_PLATFORM=egl
    export PYOPENGL_PLATFORM=egl
    export MESA_EGL_NO_X11=1
    export LIBGL_ALWAYS_INDIRECT=1
    export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

    # Python virtualenv
    export PATH=/opt/mvmae_venv/bin:$PATH

%setup
    mkdir -p /opt/app
    cp -r $PWD/SawyerSim /opt/app/
    cp -r $PWD/*.py /opt/app/
    cp $PWD/requirements.txt /opt/app/
    cp $PWD/wheelhouse /opt/wheelhouse -r

%post
    apt-get update && apt-get install -y \
        python3.12 python3.12-venv python3.12-dev \
        libegl1 libgl1-mesa-dev libgles2-mesa libglvnd0 \
        libosmesa6 libosmesa6-dev \
        mesa-utils libgl1-mesa-glx \
        libxrandr2 libxss1 libxcursor1 libxcomposite1 libxi6 \
        && apt-get clean

    # Create venv
    python3.12 -m venv /opt/mvmae_venv
    source /opt/mvmae_venv/bin/activate

    ########## INSTALL PYTHON PACKAGES ##########

    # Install Mujoco WITHOUT glfw
    pip install --no-deps mujoco==3.3.4

    # Install all wheels from wheelhouse
    pip install --no-index --find-links /opt/wheelhouse -r /opt/app/requirements.txt --no-cache-dir

    # FORCE-REMOVE glfw fully if any dependency pulled it back in
    pip uninstall -y glfw || true
    rm -rf /opt/mvmae_venv/lib/python3.12/site-packages/glfw || true

    deactivate

%runscript
    exec python3 /opt/app/trainer_pipeline_drqv2.py "$@"

