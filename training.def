Bootstrap: docker
From: nvidia/cuda:12.4.1-devel-ubuntu24.04

%labels
    Author        Daniel Zhu
    Description   MV-MAE + DrQv2 + MJX + Madrona Training Environment (CUDA 12.4, Offline bulk deps + online JAX GPU)

%files
    . /opt/src/MV_MAE_Implementation

%post
    set -e

    echo "=== [1] Installing base OS packages ==="
    apt-get update -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        git build-essential cmake pkg-config curl ca-certificates \
        ffmpeg libavcodec60 libavdevice60 libavfilter9 libavformat60 \
        libswscale7 libswresample4 \
        xvfb x11-utils libx11-dev libxrandr-dev libxinerama-dev \
        libxcursor-dev libxi-dev mesa-common-dev \
        libegl1 libegl-dev gpg lsb-release \
        python3 python3-venv python3-pip python3-dev
    rm -rf /var/lib/apt/lists/*

    echo "=== [2] Creating Python venv ==="
    python3 -m venv /opt/mvmae_venv
    . /opt/mvmae_venv/bin/activate
    python -m pip install -U pip setuptools wheel uv

    echo "=== [3] Configure offline wheelhouse for bulk deps ==="
    export TMPDIR=/opt/pip-tmp
    export PIP_CACHE_DIR=/opt/pip-cache
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export PIP_NO_INDEX=1
    mkdir -p /opt/pip-tmp /opt/pip-cache

    REQ=/opt/src/MV_MAE_Implementation/requirements.txt
    WHL=/opt/src/MV_MAE_Implementation/wheelhouse

    if [ ! -d "$WHL" ]; then
        echo "[ERROR] Missing wheelhouse at $WHL"
        exit 3
    fi
    if [ ! -f "$REQ" ]; then
        echo "[ERROR] Missing requirements.txt at $REQ"
        exit 2
    fi

    echo "=== [4] Installing Python deps (offline from wheelhouse) ==="
    python -m pip install --no-index --find-links "$WHL" -r "$REQ"

    echo "=== [5] Build Madrona-MJX (geom_quat) ==="
    # Clean any previous partial clone from earlier builds
    rm -rf /opt/madrona_mjx
    cd /opt
    git clone --branch geom_quat https://github.com/shacklettbp/madrona_mjx.git madrona_mjx
    cd /opt/madrona_mjx
    echo "[post] Running: git submodule update --init --recursive"
    git submodule update --init --recursive

    mkdir -p build
    cd build
    cmake .. -DLOAD_VULKAN=OFF
    make -j"$(nproc)"
    cd ..
    # Editable install so Python can import madrona_mjx
    uv pip install -e .

    echo "=== [6] Install CUDA 12.4 pinned NVIDIA libs ==="
    cat >/tmp/nvidia_cuda12_12.4.txt <<'REQ'
nvidia-cublas-cu12==12.4.5.8
nvidia-cuda-cupti-cu12==12.4.127
nvidia-cuda-nvcc-cu12==12.4.131
nvidia-cuda-nvrtc-cu12==12.4.127
nvidia-cuda-runtime-cu12==12.4.127
nvidia-cudnn-cu12==9.1.0.70
nvidia-cufft-cu12==11.2.1.3
nvidia-curand-cu12==10.3.5.147
nvidia-cusolver-cu12==11.6.1.9
nvidia-cusparse-cu12==12.3.1.170
nvidia-cusparselt-cu12==0.6.2
nvidia-nccl-cu12==2.21.5
nvidia-nvjitlink-cu12==12.4.127
nvidia-nvtx-cu12==12.4.127
REQ

    # Let uv talk to the network for this step (donâ€™t enforce PIP_NO_INDEX here)
    unset PIP_NO_INDEX

    # Install/override to these exact CUDA12.4 wheels
    uv pip install -r /tmp/nvidia_cuda12_12.4.txt

    echo "=== [7] Installing JAX 0.4.37 with CUDA12 local plugin (GPU JAX) ==="
    # Match the JAX version reported in the referenced issue
    uv pip install --upgrade "jax[cuda12_local]==0.4.37"

    echo "=== [8] Auto-enable venv inside container ==="
    mkdir -p /.singularity.d/env
    cat > /.singularity.d/env/99-autovenv.sh <<'EOS'
export VIRTUAL_ENV=/opt/mvmae_venv
export PATH="$VIRTUAL_ENV/bin:$PATH"
export PYTHONPATH="/opt/src:${PYTHONPATH}"
EOS
    chmod 644 /.singularity.d/env/99-autovenv.sh

    echo "=== Build Completed Successfully ==="


%environment
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export DISPLAY=:1
    export HF_TOKEN=${HF_TOKEN:-}
    export WANDB_API_KEY=${WANDB_API_KEY:-}


%runscript
    if command -v nvidia-smi >/dev/null 2>&1; then
        echo "GPU:"
        nvidia-smi
    fi

    . /opt/mvmae_venv/bin/activate
    cd /opt/src

    echo "[MVMAE] Running training script..."
    exec python -m MV_MAE_Implementation.train_drqv2_mujoco "$@"


%help
    Offline MV-MAE / DrQv2 / MJX + Madrona container.
    - Bulk deps (torch, mujoco, etc.) from local wheelhouse.
    - NVIDIA CUDA 12.4 wheels pinned.
    - JAX 0.4.37 with cuda12_local plugin installed from PyPI (GPU backend).

    Build:
      apptainer build training.sif training.def

    Run default training:
      apptainer run --nv training.sif

    Exec custom:
      apptainer exec --nv training.sif python3
