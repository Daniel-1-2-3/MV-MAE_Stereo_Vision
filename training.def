Bootstrap: docker
From: nvidia/cuda:12.8.0-devel-ubuntu24.04

%labels
    Author        Daniel Zhu
    Description   MV-MAE + DrQv2 • CUDA 12.8 • Headless EGL • MuJoCo 3.3.4

%files
    . /opt/app

%post -c /bin/bash
set -euo pipefail

###############
# SYSTEM DEPS #
###############
apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates curl git build-essential pkg-config \
    python3 python3-venv python3-pip \
    ffmpeg \
    libgl1 libgles2 libegl1 libglvnd0 libglvnd-dev libglx0 \
    libopengl0 libxkbcommon0 \
    libxext6 libx11-6 \
    && rm -rf /var/lib/apt/lists/*

###############
# PYTHON VENV #
###############
python3 -m venv /opt/mvmae_venv
. /opt/mvmae_venv/bin/activate

pip install -U pip setuptools wheel

APP=/opt/app
REQ="$APP/requirements.txt"
WHL="$APP/wheelhouse"

mkdir -p /opt/pip-tmp /opt/pip-cache
export TMPDIR=/opt/pip-tmp
export PIP_CACHE_DIR=/opt/pip-cache
export PIP_DISABLE_PIP_VERSION_CHECK=1

echo "[post] Installing Python deps..."

ONLINE=0
if [ -d "$WHL" ] && [ -f "$REQ" ]; then
    pip install --no-index --find-links "$WHL" -r "$REQ" || ONLINE=1
else
    ONLINE=1
fi

if [ "$ONLINE" = 1 ]; then
    pip install --no-cache-dir \
        dm_control==1.0.31 mujoco==3.3.4 dm_env==1.6 \
        einops gymnasium \
        numpy scipy pillow matplotlib tqdm opencv-python lpips timm tokenizers \
        imageio imageio-ffmpeg omegaconf hydra-core \
        --extra-index-url https://download.pytorch.org/whl/cu121 \
        torch==2.6.0 torchvision==0.21.0
fi

###########################
# AUTO-ACTIVATE VENV     #
###########################
cat > /.singularity.d/env/99-venv.sh << 'EOF'
export VIRTUAL_ENV=/opt/mvmae_venv
export PATH="$VIRTUAL_ENV/bin:$PATH"
export PYTHONPATH="/opt/app:/opt/app/DrQv2_Architecture:${PYTHONPATH}"
export MUJOCO_GL=egl
export PYOPENGL_PLATFORM=egl
export MESA_EGL_NO_X11=1
export LIBGL_ALWAYS_SOFTWARE=0
export OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}
EOF

chmod 644 /.singularity.d/env/99-venv.sh

%environment
export VIRTUAL_ENV=/opt/mvmae_venv
export PATH="$VIRTUAL_ENV/bin:$PATH"
export PYTHONPATH="/opt/app:/opt/app/DrQv2_Architecture:${PYTHONPATH}"
export MUJOCO_GL=egl
export PYOPENGL_PLATFORM=egl
export MESA_EGL_NO_X11=1
export LIBGL_ALWAYS_SOFTWARE=0
export OMP_NUM_THREADS=${OMP_NUM_THREADS:-4}

%runscript
set -eu  # no pipefail here
. /opt/mvmae_venv/bin/activate
cd /opt/app

MAIN="/opt/app/trainer_pipeline_drqv2.py"

echo "[MVMAE] Running training…"
exec python -u "$MAIN" "$@"
